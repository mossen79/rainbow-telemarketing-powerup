<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainbow Telemarketing Scripts</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
</head>
<body>
    <div id="script-container">
        <div id="script-header">
            <h2 id="script-title">Skrypt Rozmowy</h2>
        </div>

        <div id="script-content">
            <div id="script-text-box">
                <div class="label">POWIEDZ:</div>
                <div id="script-text" class="speech-box"></div>
            </div>

            <div id="responses-section">
                <div class="label">KLIENT ODPOWIEDZIAŁ:</div>
                <div id="response-buttons"></div>
            </div>
        </div>

        <div id="script-footer">
            <button id="back-btn" class="secondary-btn" style="display:none;">Cofnij</button>
            <button id="close-btn" class="secondary-btn">Zamknij</button>
        </div>

        <div id="history-panel" style="display:none;">
            <div class="label">Historia rozmowy:</div>
            <div id="history-list"></div>
        </div>
    </div>

    <script>
        var t = TrelloPowerUp.iframe();
        const APP_KEY = '538572f48dd27b2c1be5bc2dcdd12bdc';

        const SCRIPT_DATA = {"name":"Odkurzacz Rainbow - Umówienie prezentacji","description":"Skrypt do umówienia darmowej prezentacji odkurzacza Rainbow","version":"1.0","steps":{"start":{"name":"Powitanie","say":"Dzień dobry, nazywam się [TWOJE IMIĘ], dzwonię z firmy Rainbow System.\n\nCzy mogę rozmawiać z Panią/Panem [IMIĘ Z LEADA]?","responses":[{"label":"Tak, słucham","next":"intro"},{"label":"To nie ja / Zły numer","next":"wrong_number"},{"label":"Nie mam czasu teraz","next":"callback_request"},{"label":"Nie interesuje mnie","next":"objection_start"}]},"intro":{"name":"Wprowadzenie","say":"Dzwonię w sprawie darmowej prezentacji odkurzacza Rainbow System.\n\nCzy słyszała/słyszał Pani/Pan o tej marce?","responses":[{"label":"Tak, znam Rainbow","next":"pitch_short"},{"label":"Nie, nie znam","next":"pitch_full"},{"label":"Mam już Rainbow","next":"already_has"},{"label":"Nie interesuje mnie","next":"objection_1"}]},"pitch_full":{"name":"Pełna prezentacja oferty","say":"Rainbow to amerykański system czyszczenia z 90-letnią tradycją. Nie jest to zwykły odkurzacz - to profesjonalny system oczyszczania powietrza i czyszczenia całego domu.\n\nPrezentacja jest całkowicie darmowa, trwa około 45 minut i odbywa się w Państwa domu. Pokażemy jak Rainbow czyści dywany, materace, usunie kurz i roztocza.\n\nKiedy mogłabym/mógłbym umówić prezentację?","responses":[{"label":"Dzisiaj / Jutro","next":"book_soon"},{"label":"W tym tygodniu","next":"book_this_week"},{"label":"W weekend","next":"book_weekend"},{"label":"Muszę pomyśleć","next":"objection_think"},{"label":"To za drogie","next":"objection_price"}]},"pitch_short":{"name":"Krótka prezentacja oferty","say":"Świetnie! To Pani/Pan wie jaka to solidna marka.\n\nOrganizujemy darmowe prezentacje w domach klientów. Trwa 45 minut, pokażemy wszystkie możliwości Rainbow - czyszczenie dywanów, materaców, usuwanie roztoczy.\n\nKiedy mogłabym/mógłbym umówić prezentację?","responses":[{"label":"Dzisiaj / Jutro","next":"book_soon"},{"label":"W tym tygodniu","next":"book_this_week"},{"label":"W weekend","next":"book_weekend"},{"label":"Muszę pomyśleć","next":"objection_think"}]},"book_soon":{"name":"Umawianie na najbliższe dni","say":"Doskonale! Proszę wybrać dogodny termin z kalendarza.\n\nPrezentacje prowadzimy: 10:00, 13:00, 16:00, 18:00, 19:30","responses":[{"label":"Wybierz termin","useCalendar":true,"next":"confirm_booking"}]},"book_this_week":{"name":"Umawianie w tym tygodniu","say":"Świetnie! Proszę wybrać dogodny termin z kalendarza.\n\nPrezentacje prowadzimy: 10:00, 13:00, 16:00, 18:00, 19:30","responses":[{"label":"Wybierz termin","useCalendar":true,"next":"confirm_booking"}]},"book_weekend":{"name":"Umawianie na weekend","say":"Rozumiem, weekend to dobry czas. Proszę wybrać dogodny termin z kalendarza.\n\nPrezentacje w weekendy: Sobota (10:00, 13:00, 16:00), Niedziela (11:00, 14:00, 17:00)","responses":[{"label":"Wybierz termin","useCalendar":true,"next":"confirm_booking"}]},"custom_time":{"name":"Niestandardowy termin","say":"Oczywiście, dostosujemy się do Państwa.\n\nProszę podać preferowany dzień i godzinę, a ja sprawdzę dostępność prezentera.","responses":[{"label":"Klient podał termin - zapisz","next":"confirm_booking"},{"label":"Nie może ustalić teraz","next":"callback_request"}]},"confirm_booking":{"name":"Potwierdzenie rezerwacji","say":"Doskonale! Rezerwuję termin prezentacji Rainbow.\n\nProszę potwierdzić dane kontaktowe:\n• Numer telefonu: [NUMER Z LEADA]\n• Adres: [ZAPYTAJ O ADRES]\n\nPrześlę Pani/Panu SMS z potwierdzeniem i numerem do prezentera.\n\nDo zobaczenia!","responses":[{"label":"UMÓWIONO - Zapisz w Trello","next":null}]},"objection_start":{"name":"Obiekcja na starcie","say":"Rozumiem. Czy mogę zapytać co konkretnie Pani/Pana nie interesuje - prezentacja czy sam odkurzacz?","responses":[{"label":"Odkurzacz (za drogi)","next":"objection_price"},{"label":"Nie mam czasu","next":"objection_time"},{"label":"Nic mnie nie interesuje","next":"end_not_interested"}]},"objection_1":{"name":"Obiekcja po intro","say":"Rozumiem Pani/Pana wątpliwości. Ale to nie jest spotkanie sprzedażowe - to darmowa prezentacja.\n\nWiele osób po prezentacji jest zaskoczonych możliwościami Rainbow. Nie traci Pani/Pan nic, pokazujemy tylko jak działa.\n\nCzy mogę umówić prezentację?","responses":[{"label":"OK, umów","next":"book_this_week"},{"label":"Dalej nie","next":"objection_final"}]},"objection_think":{"name":"Muszę pomyśleć","say":"Oczywiście, rozumiem. To ważna decyzja.\n\nCzy mogę oddzwonić jutro lub pojutrze i umówić prezentację? To nic nie kosztuje, a zobaczy Pani/Pan Rainbow na żywo.","responses":[{"label":"Tak, proszę oddzwonić","next":"callback_scheduled"},{"label":"Nie, dziękuję","end_not_interested"}]},"objection_price":{"name":"Obiekcja cenowa","say":"Rozumiem obawy o cenę. Ale prawda jest taka, że Rainbow to inwestycja na 20-30 lat.\n\nOfferujemy też raty 0% i programy leasingowe. Prezentacja jest za darmo - warto zobaczyć co dostaje się za tę cenę.\n\nCzy mogę umówić prezentację?","responses":[{"label":"OK, umów prezentację","next":"book_this_week"},{"label":"To i tak za drogo","next":"end_not_interested"}]},"objection_time":{"name":"Brak czasu","say":"Rozumiem, każdy ma teraz mało czasu.\n\nPrezentacja trwa tylko 45 minut i dostosujemy się do Państwa - możemy przyjechać wieczorem, w weekend, kiedy Pani/Panu pasuje.\n\nJaki termin byłby najwygodniejszy?","responses":[{"label":"OK, umów na weekend","next":"book_weekend"},{"label":"Dalej nie mam czasu","next":"callback_request"}]},"objection_final":{"name":"Ostatnia próba","say":"Rozumiem. Może po prostu zostawię swój numer - gdyby zmieniła/zmienił Pani/Pan zdanie, proszę zadzwonić.\n\nNumer: 123-456-789\n\nDziękuję za rozmowę!","responses":[{"label":"NIE ZAINTERESOWANY - Zapisz","next":null}]},"already_has":{"name":"Ma już Rainbow","say":"Wspaniale! To znaczy że zna Pani/Pan jakość Rainbow.\n\nCzy wie Pani/Pan że mamy teraz program wymiany starszych modeli na nowe z rabatem? Nowe modele mają dodatkowe funkcje.\n\nCzy mogę umówić prezentację nowego modelu?","responses":[{"label":"Tak, interesuje mnie","next":"book_this_week"},{"label":"Nie, mój działa OK","next":"end_has_rainbow"}]},"wrong_number":{"name":"Zły numer","say":"Rozumiem, przepraszam za pomyłkę.\n\nMiłego dnia!","responses":[{"label":"ZŁY NUMER - Zapisz","next":null}]},"callback_request":{"name":"Prośba o telefon zwrotny","say":"Oczywiście, rozumiem.\n\nKiedy mogę oddzwonić? Jutro, pojutrze?","responses":[{"label":"Jutro (podaj godzinę)","next":"callback_scheduled"},{"label":"Za kilka dni","next":"callback_scheduled"},{"label":"Ja sam/sama zadzwonię","next":"end_callback_client"}]},"callback_scheduled":{"name":"Potwierdzenie oddzwonienia","say":"Super! Zapisuję i oddzwonię w ustalonym terminie.\n\nDziękuję, do usłyszenia!","responses":[{"label":"ODDZWONIĆ - Zapisz w Trello","next":null}]},"end_not_interested":{"name":"Koniec - nie zainteresowany","say":"Rozumiem. Dziękuję za poświęcony czas.\n\nMiłego dnia!","responses":[{"label":"NIE ZAINTERESOWANY - Zapisz","next":null}]},"end_has_rainbow":{"name":"Koniec - ma Rainbow","say":"Cieszę się że Rainbow Państwu służy!\n\nGdyby w przyszłości potrzebowali Państwo serwisu lub akcesoriów - proszę dzwonić.\n\nMiłego dnia!","responses":[{"label":"MA JUŻ RAINBOW - Zapisz","next":null}]},"end_callback_client":{"name":"Koniec - klient oddzwoni","say":"Oczywiście! Mój numer: 123-456-789\n\nCzekam na telefon. Miłego dnia!","responses":[{"label":"KLIENT ODDZWONI - Zapisz","next":null}]}}};

        class ScriptEngine {
            constructor(scriptData) {
                this.scriptData = scriptData;
                this.currentStep = 'start';
                this.history = [];
            }

            getCurrentStep() {
                if (!this.scriptData || !this.scriptData.steps[this.currentStep]) {
                    return null;
                }
                return this.scriptData.steps[this.currentStep];
            }

            selectResponse(responseIndex) {
                const currentStep = this.getCurrentStep();
                if (!currentStep || !currentStep.responses[responseIndex]) {
                    return false;
                }

                const response = currentStep.responses[responseIndex];

                this.history.push({
                    step: this.currentStep,
                    stepName: currentStep.name || this.currentStep,
                    said: currentStep.say,
                    response: response.label
                });

                if (response.next === null) {
                    return { end: true, outcome: response.label };
                } else {
                    this.currentStep = response.next;
                    return { end: false };
                }
            }

            goBack() {
                if (this.history.length === 0) {
                    return false;
                }

                this.history.pop();

                if (this.history.length > 0) {
                    const lastHistory = this.history[this.history.length - 1];
                    const lastStep = this.scriptData.steps[lastHistory.step];
                    const lastResponse = lastStep.responses.find(r => r.label === lastHistory.response);
                    this.currentStep = lastResponse.next;
                } else {
                    this.currentStep = 'start';
                }

                return true;
            }

            getHistory() {
                return this.history;
            }
        }

        class ScriptUI {
            constructor(engine) {
                this.engine = engine;
                this.initElements();
                this.attachEventListeners();
                this.render();
            }

            initElements() {
                this.scriptText = document.getElementById('script-text');
                this.responseButtons = document.getElementById('response-buttons');
                this.backBtn = document.getElementById('back-btn');
                this.closeBtn = document.getElementById('close-btn');
                this.historyPanel = document.getElementById('history-panel');
                this.historyList = document.getElementById('history-list');
            }

            attachEventListeners() {
                this.backBtn.addEventListener('click', () => this.handleBack());
                this.closeBtn.addEventListener('click', () => this.handleClose());
            }

            render() {
                const step = this.engine.getCurrentStep();

                if (!step) {
                    this.showError('Błąd: brak kroku');
                    return;
                }

                this.scriptText.textContent = step.say;
                this.responseButtons.innerHTML = '';

                step.responses.forEach((response, index) => {
                    if (response.useCalendar) {
                        const dateGroup = document.createElement('div');
                        dateGroup.style.marginTop = '20px';

                        const label = document.createElement('label');
                        label.textContent = 'Termin prezentacji:';
                        label.style.display = 'block';
                        label.style.marginBottom = '10px';
                        label.style.fontWeight = 'bold';

                        const input = document.createElement('input');
                        input.type = 'date';
                        input.className = 'date-input';
                        input.min = new Date().toISOString().split('T')[0];
                        input.style.padding = '10px';
                        input.style.fontSize = '16px';
                        input.style.width = '100%';
                        input.style.border = '2px solid #0079bf';
                        input.style.borderRadius = '4px';

                        const button = document.createElement('button');
                        button.className = 'response-btn success';
                        button.textContent = 'Potwierdź termin';
                        button.style.marginTop = '10px';
                        button.addEventListener('click', () => {
                            if (input.value) {
                                this.handleDateSelection(input.value, response, index);
                            } else {
                                alert('Proszę wybrać datę');
                            }
                        });

                        dateGroup.appendChild(label);
                        dateGroup.appendChild(input);
                        dateGroup.appendChild(button);
                        this.responseButtons.appendChild(dateGroup);
                    } else {
                        const button = document.createElement('button');
                        button.className = 'response-btn';
                        button.textContent = response.label;

                        if (response.label.includes('UMÓWIONO') || response.label.toLowerCase().includes('umówiono')) {
                            button.classList.add('success');
                        } else if (response.label.includes('NIE ZAINTERESOWANY') || response.label.includes('ZŁY NUMER')) {
                            button.classList.add('danger');
                        } else if (response.label.includes('ODDZWONIĆ') || response.label.toLowerCase().includes('później')) {
                            button.classList.add('warning');
                        }

                        button.addEventListener('click', () => this.handleResponse(index));
                        this.responseButtons.appendChild(button);
                    }
                });

                this.backBtn.style.display = this.engine.history.length > 0 ? 'block' : 'none';
                this.updateHistory();
            }

            handleDateSelection(dateValue, response, index) {
                const selectedDate = new Date(dateValue);
                const dateStr = selectedDate.toLocaleDateString('pl-PL', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const currentStep = this.engine.getCurrentStep();
                this.engine.history.push({
                    step: this.engine.currentStep,
                    stepName: currentStep.name || this.engine.currentStep,
                    said: currentStep.say,
                    response: `${response.label} - ${dateStr}`,
                    selectedDate: dateValue
                });

                if (response.next === null) {
                    this.showEndScreen(response.label);
                } else {
                    this.engine.currentStep = response.next;
                    this.render();
                }
            }

            handleResponse(index) {
                const result = this.engine.selectResponse(index);

                if (result.end) {
                    this.showEndScreen(result.outcome);
                } else {
                    this.render();
                }
            }

            handleBack() {
                const success = this.engine.goBack();
                if (success) {
                    this.render();
                }
            }

            handleClose() {
                t.closeModal();
            }

            updateHistory() {
                const history = this.engine.getHistory();

                if (history.length === 0) {
                    this.historyPanel.style.display = 'none';
                    return;
                }

                this.historyPanel.style.display = 'block';
                this.historyList.innerHTML = '';

                history.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.textContent = `${index + 1}. ${item.stepName || 'Krok'} -> ${item.response}`;
                    this.historyList.appendChild(historyItem);
                });
            }

            async showEndScreen(outcome) {
                await this.saveConversationToTrello(outcome);

                const container = document.getElementById('script-content');
                container.innerHTML = `
                    <div class="end-screen">
                        <h3>Rozmowa zakończona</h3>
                        <p><strong>Wynik:</strong> ${outcome}</p>
                        <p>Przebieg rozmowy został zapisany w komentarzu.</p>
                        <p>Możesz teraz zamknąć to okno.</p>
                    </div>
                `;

                this.closeBtn.textContent = 'Zamknij i wróć do Trello';
                this.backBtn.style.display = 'none';
            }

            async saveConversationToTrello(outcome) {
                try {
                    const history = this.engine.getHistory();

                    let comment = `**Przebieg rozmowy - Rainbow Telemarketing**\n\n`;
                    comment += `**Wynik:** ${outcome}\n\n`;
                    comment += `**Historia rozmowy:**\n`;

                    history.forEach((item, index) => {
                        comment += `${index + 1}. **${item.stepName}**\n`;
                        comment += `   Powiedziałem: "${item.said.substring(0, 100)}${item.said.length > 100 ? '...' : ''}"\n`;
                        comment += `   Klient odpowiedział: ${item.response}\n`;
                        if (item.selectedDate) {
                            comment += `   Data spotkania: ${item.selectedDate}\n`;
                        }
                        comment += `\n`;
                    });

                    comment += `\n---\nWygenerowano przez Rainbow Telemarketing Scripts`;

                    const card = await t.card('id');
                    const cardId = card.id;

                    const restApi = t.getRestApi();
                    const isAuthorized = await restApi.isAuthorized();

                    if (!isAuthorized) {
                        await restApi.authorize({ scope: 'read,write' });
                    }

                    const token = await restApi.getToken();

                    const url = `https://api.trello.com/1/cards/${cardId}/actions/comments?key=${APP_KEY}&token=${token}&text=${encodeURIComponent(comment)}`;

                    const response = await fetch(url, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        console.log('Komentarz zapisany w Trello');
                    } else {
                        const errorText = await response.text();
                        console.error('Błąd zapisu:', response.status, errorText);
                    }
                } catch (error) {
                    console.error('Błąd zapisywania komentarza:', error);
                }
            }

            showError(message) {
                const container = document.getElementById('script-content');
                container.innerHTML = `
                    <div class="end-screen">
                        <h3>Błąd</h3>
                        <p>${message}</p>
                    </div>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const scriptEngine = new ScriptEngine(SCRIPT_DATA);
            const scriptUI = new ScriptUI(scriptEngine);
        });
    </script>
</body>
</html>
