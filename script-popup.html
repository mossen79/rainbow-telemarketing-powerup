<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainbow Telemarketing Scripts</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script src="./config.js"></script>
    <script src="./trello-actions-config.js"></script>
    <script src="./trello-automation.js"></script>
</head>
<body>
    <div id="script-container">
        <div id="script-header">
            <h2 id="script-title">Skrypt Rozmowy</h2>
        </div>

        <div id="script-content">
            <div id="script-text-box">
                <div class="label">POWIEDZ:</div>
                <div id="script-text" class="speech-box"></div>
            </div>

            <div id="responses-section">
                <div class="label">KLIENT ODPOWIEDZIA≈Å:</div>
                <div id="response-buttons"></div>
            </div>
        </div>

        <div id="script-footer">
            <button id="back-btn" class="secondary-btn" style="display:none;">‚Üê Cofnij</button>
            <button id="close-btn" class="secondary-btn">‚úï Zamknij</button>
        </div>

        <div id="history-panel" style="display:none;">
            <div class="label">Historia rozmowy:</div>
            <div id="history-list"></div>
        </div>

        <!-- Error/Warning notifications -->
        <div id="notification" class="notification" style="display:none;"></div>
    </div>

    <script>
        var t = TrelloPowerUp.iframe();
        // Use API key from config.js (loaded above)
        const APP_KEY = (typeof CONFIG !== 'undefined' && CONFIG.TRELLO_APP_KEY) 
            ? CONFIG.TRELLO_APP_KEY 
            : '538572f48dd27b2c1be5bc2dcdd12bdc'; // Fallback for development

        const SCRIPT_DATA = {"name":"Odkurzacz Rainbow - Um√≥wienie prezentacji","description":"Skrypt do um√≥wienia darmowej prezentacji odkurzacza Rainbow","version":"1.0","steps":{"start":{"name":"Powitanie","say":"Dzie≈Ñ dobry, nazywam siƒô [TWOJE IMIƒò], dzwoniƒô z firmy Rainbow System.\n\nCzy mogƒô rozmawiaƒá z PaniƒÖ/Panem [IMIƒò Z LEADA]?","responses":[{"label":"Tak, s≈Çucham","next":"intro"},{"label":"To nie ja / Z≈Çy numer","next":"wrong_number"},{"label":"Nie mam czasu teraz","next":"callback_request"},{"label":"Nie interesuje mnie","next":"objection_start"}]},"intro":{"name":"Wprowadzenie","say":"Dzwoniƒô w sprawie darmowej prezentacji odkurzacza Rainbow System.\n\nCzy s≈Çysza≈Ça/s≈Çysza≈Ç Pani/Pan o tej marce?","responses":[{"label":"Tak, znam Rainbow","next":"pitch_short"},{"label":"Nie, nie znam","next":"pitch_full"},{"label":"Mam ju≈º Rainbow","next":"already_has"},{"label":"Nie interesuje mnie","next":"objection_1"}]},"pitch_full":{"name":"Pe≈Çna prezentacja oferty","say":"Rainbow to ameryka≈Ñski system czyszczenia z 90-letniƒÖ tradycjƒÖ. Nie jest to zwyk≈Çy odkurzacz - to profesjonalny system oczyszczania powietrza i czyszczenia ca≈Çego domu.\n\nPrezentacja jest ca≈Çkowicie darmowa, trwa oko≈Ço 45 minut i odbywa siƒô w Pa≈Ñstwa domu. Poka≈ºemy jak Rainbow czy≈õci dywany, materace, usunie kurz i roztocza.\n\nKiedy mog≈Çabym/m√≥g≈Çbym um√≥wiƒá prezentacjƒô?","responses":[{"label":"Dzisiaj / Jutro","next":"book_soon"},{"label":"W tym tygodniu","next":"book_this_week"},{"label":"W weekend","next":"book_weekend"},{"label":"Muszƒô pomy≈õleƒá","next":"objection_think"},{"label":"To za drogie","next":"objection_price"}]},"pitch_short":{"name":"Kr√≥tka prezentacja oferty","say":"≈öwietnie! To Pani/Pan wie jaka to solidna marka.\n\nOrganizujemy darmowe prezentacje w domach klient√≥w. Trwa 45 minut, poka≈ºemy wszystkie mo≈ºliwo≈õci Rainbow - czyszczenie dywan√≥w, materac√≥w, usuwanie roztoczy.\n\nKiedy mog≈Çabym/m√≥g≈Çbym um√≥wiƒá prezentacjƒô?","responses":[{"label":"Dzisiaj / Jutro","next":"book_soon"},{"label":"W tym tygodniu","next":"book_this_week"},{"label":"W weekend","next":"book_weekend"},{"label":"Muszƒô pomy≈õleƒá","next":"objection_think"}]},"book_soon":{"name":"Umawianie na najbli≈ºsze dni","say":"Doskonale! Proszƒô wybraƒá dogodny termin z kalendarza.\n\nPrezentacje prowadzimy: 10:00, 13:00, 16:00, 18:00, 19:30","responses":[{"label":"Wybierz termin","useCalendar":true,"next":"confirm_booking"}]},"book_this_week":{"name":"Umawianie w tym tygodniu","say":"≈öwietnie! Proszƒô wybraƒá dogodny termin z kalendarza.\n\nPrezentacje prowadzimy: 10:00, 13:00, 16:00, 18:00, 19:30","responses":[{"label":"Wybierz termin","useCalendar":true,"next":"confirm_booking"}]},"book_weekend":{"name":"Umawianie na weekend","say":"Rozumiem, weekend to dobry czas. Proszƒô wybraƒá dogodny termin z kalendarza.\n\nPrezentacje w weekendy: Sobota (10:00, 13:00, 16:00), Niedziela (11:00, 14:00, 17:00)","responses":[{"label":"Wybierz termin","useCalendar":true,"next":"confirm_booking"}]},"custom_time":{"name":"Niestandardowy termin","say":"Oczywi≈õcie, dostosujemy siƒô do Pa≈Ñstwa.\n\nProszƒô podaƒá preferowany dzie≈Ñ i godzinƒô, a ja sprawdzƒô dostƒôpno≈õƒá prezentera.","responses":[{"label":"Klient poda≈Ç termin - zapisz","next":"confirm_booking"},{"label":"Nie mo≈ºe ustaliƒá teraz","next":"callback_request"}]},"confirm_booking":{"name":"Potwierdzenie rezerwacji","say":"Doskonale! Rezerwujƒô termin prezentacji Rainbow.\n\nProszƒô potwierdziƒá dane kontaktowe:\n‚Ä¢ Numer telefonu: [NUMER Z LEADA]\n‚Ä¢ Adres: [ZAPYTAJ O ADRES]\n\nPrze≈õlƒô Pani/Panu SMS z potwierdzeniem i numerem do prezentera.\n\nDo zobaczenia!","responses":[{"label":"‚úÖ UM√ìWIONO - Zapisz w Trello","next":null}]},"objection_start":{"name":"Obiekcja na starcie","say":"Rozumiem. Czy mogƒô zapytaƒá co konkretnie Pani/Pana nie interesuje - prezentacja czy sam odkurzacz?","responses":[{"label":"Odkurzacz (za drogi)","next":"objection_price"},{"label":"Nie mam czasu","next":"objection_time"},{"label":"Nic mnie nie interesuje","next":"end_not_interested"}]},"objection_1":{"name":"Obiekcja po intro","say":"Rozumiem Pani/Pana wƒÖtpliwo≈õci. Ale to nie jest spotkanie sprzeda≈ºowe - to darmowa prezentacja.\n\nWiele os√≥b po prezentacji jest zaskoczonych mo≈ºliwo≈õciami Rainbow. Nie traci Pani/Pan nic, pokazujemy tylko jak dzia≈Ça.\n\nCzy mogƒô um√≥wiƒá prezentacjƒô?","responses":[{"label":"OK, um√≥w","next":"book_this_week"},{"label":"Dalej nie","next":"objection_final"}]},"objection_think":{"name":"Muszƒô pomy≈õleƒá","say":"Oczywi≈õcie, rozumiem. To wa≈ºna decyzja.\n\nCzy mogƒô oddzwoniƒá jutro lub pojutrze i um√≥wiƒá prezentacjƒô? To nic nie kosztuje, a zobaczy Pani/Pan Rainbow na ≈ºywo.","responses":[{"label":"Tak, proszƒô oddzwoniƒá","next":"callback_scheduled"},{"label":"Nie, dziƒôkujƒô","next":"end_not_interested"}]},"objection_price":{"name":"Obiekcja cenowa","say":"Rozumiem obawy o cenƒô. Ale prawda jest taka, ≈ºe Rainbow to inwestycja na 20-30 lat.\n\nOfferujemy te≈º raty 0% i programy leasingowe. Prezentacja jest za darmo - warto zobaczyƒá co dostaje siƒô za tƒô cenƒô.\n\nCzy mogƒô um√≥wiƒá prezentacjƒô?","responses":[{"label":"OK, um√≥w prezentacjƒô","next":"book_this_week"},{"label":"To i tak za drogo","next":"end_not_interested"}]},"objection_time":{"name":"Brak czasu","say":"Rozumiem, ka≈ºdy ma teraz ma≈Ço czasu.\n\nPrezentacja trwa tylko 45 minut i dostosujemy siƒô do Pa≈Ñstwa - mo≈ºemy przyjechaƒá wieczorem, w weekend, kiedy Pani/Panu pasuje.\n\nJaki termin by≈Çby najwygodniejszy?","responses":[{"label":"OK, um√≥w na weekend","next":"book_weekend"},{"label":"Dalej nie mam czasu","next":"callback_request"}]},"objection_final":{"name":"Ostatnia pr√≥ba","say":"Rozumiem. Mo≈ºe po prostu zostawiƒô sw√≥j numer - gdyby zmieni≈Ça/zmieni≈Ç Pani/Pan zdanie, proszƒô zadzwoniƒá.\n\nNumer: 123-456-789\n\nDziƒôkujƒô za rozmowƒô!","responses":[{"label":"‚ùå NIE ZAINTERESOWANY - Zapisz","next":null}]},"already_has":{"name":"Ma ju≈º Rainbow","say":"Wspaniale! To znaczy ≈ºe zna Pani/Pan jako≈õƒá Rainbow.\n\nCzy wie Pani/Pan ≈ºe mamy teraz program wymiany starszych modeli na nowe z rabatem? Nowe modele majƒÖ dodatkowe funkcje.\n\nCzy mogƒô um√≥wiƒá prezentacjƒô nowego modelu?","responses":[{"label":"Tak, interesuje mnie","next":"book_this_week"},{"label":"Nie, m√≥j dzia≈Ça OK","next":"end_has_rainbow"}]},"wrong_number":{"name":"Z≈Çy numer","say":"Rozumiem, przepraszam za pomy≈Çkƒô.\n\nMi≈Çego dnia!","responses":[{"label":"‚ùå Z≈ÅY NUMER - Zapisz","next":null}]},"callback_request":{"name":"Pro≈õba o telefon zwrotny","say":"Oczywi≈õcie, rozumiem.\n\nKiedy mogƒô oddzwoniƒá? Jutro, pojutrze?","responses":[{"label":"Jutro (podaj godzinƒô)","next":"callback_scheduled"},{"label":"Za kilka dni","next":"callback_scheduled"},{"label":"Ja sam/sama zadzwoniƒô","next":"end_callback_client"}]},"callback_scheduled":{"name":"Potwierdzenie oddzwonienia","say":"Super! Zapisujƒô i oddzwoniƒô w ustalonym terminie.\n\nDziƒôkujƒô, do us≈Çyszenia!","responses":[{"label":"‚è∞ ODDZWONIƒÜ - Zapisz w Trello","next":null}]},"end_not_interested":{"name":"Koniec - nie zainteresowany","say":"Rozumiem. Dziƒôkujƒô za po≈õwiƒôcony czas.\n\nMi≈Çego dnia!","responses":[{"label":"‚ùå NIE ZAINTERESOWANY - Zapisz","next":null}]},"end_has_rainbow":{"name":"Koniec - ma Rainbow","say":"Cieszƒô siƒô ≈ºe Rainbow Pa≈Ñstwu s≈Çu≈ºy!\n\nGdyby w przysz≈Ço≈õci potrzebowali Pa≈Ñstwo serwisu lub akcesori√≥w - proszƒô dzwoniƒá.\n\nMi≈Çego dnia!","responses":[{"label":"‚úÖ MA JU≈ª RAINBOW - Zapisz","next":null}]},"end_callback_client":{"name":"Koniec - klient oddzwoni","say":"Oczywi≈õcie! M√≥j numer: 123-456-789\n\nCzekam na telefon. Mi≈Çego dnia!","responses":[{"label":"üìû KLIENT ODDZWONI - Zapisz","next":null}]}}};

        class ScriptEngine {
            constructor(scriptData) {
                this.scriptData = scriptData;
                this.currentStep = 'start';
                this.history = [];
            }

            getCurrentStep() {
                if (!this.scriptData || !this.scriptData.steps[this.currentStep]) {
                    return null;
                }
                return this.scriptData.steps[this.currentStep];
            }

            selectResponse(responseIndex) {
                const currentStep = this.getCurrentStep();
                if (!currentStep || !currentStep.responses[responseIndex]) {
                    return false;
                }

                const response = currentStep.responses[responseIndex];

                this.history.push({
                    step: this.currentStep,
                    stepName: currentStep.name || this.currentStep,
                    said: currentStep.say,
                    response: response.label
                });

                if (response.next === null) {
                    return { end: true, outcome: response.label };
                } else {
                    this.currentStep = response.next;
                    return { end: false };
                }
            }

            goBack() {
                if (this.history.length === 0) {
                    return false;
                }

                this.history.pop();

                if (this.history.length > 0) {
                    const lastHistory = this.history[this.history.length - 1];
                    const lastStep = this.scriptData.steps[lastHistory.step];
                    const lastResponse = lastStep.responses.find(r => r.label === lastHistory.response);
                    this.currentStep = lastResponse.next;
                } else {
                    this.currentStep = 'start';
                }

                return true;
            }

            getHistory() {
                return this.history;
            }
        }

        class ScriptUI {
            constructor(engine) {
                this.engine = engine;
                this.initElements();
                this.attachEventListeners();
                this.render();
            }

            initElements() {
                this.scriptText = document.getElementById('script-text');
                this.responseButtons = document.getElementById('response-buttons');
                this.backBtn = document.getElementById('back-btn');
                this.closeBtn = document.getElementById('close-btn');
                this.historyPanel = document.getElementById('history-panel');
                this.historyList = document.getElementById('history-list');
            }

            attachEventListeners() {
                this.backBtn.addEventListener('click', () => this.handleBack());
                this.closeBtn.addEventListener('click', () => this.handleClose());
            }

            render() {
                const step = this.engine.getCurrentStep();

                if (!step) {
                    this.showError('B≈ÇƒÖd: brak kroku');
                    return;
                }

                this.scriptText.textContent = step.say;
                this.responseButtons.innerHTML = '';

                step.responses.forEach((response, index) => {
                    if (response.useCalendar) {
                        const dateGroup = document.createElement('div');
                        dateGroup.style.marginTop = '20px';

                        const label = document.createElement('label');
                        label.textContent = 'Termin prezentacji:';
                        label.style.display = 'block';
                        label.style.marginBottom = '10px';
                        label.style.fontWeight = 'bold';

                        const input = document.createElement('input');
                        input.type = 'date';
                        input.className = 'date-input';
                        input.min = new Date().toISOString().split('T')[0];
                        input.style.padding = '10px';
                        input.style.fontSize = '16px';
                        input.style.width = '100%';
                        input.style.border = '2px solid #0079bf';
                        input.style.borderRadius = '4px';

                        const button = document.createElement('button');
                        button.className = 'response-btn success';
                        button.textContent = 'Potwierd≈∫ termin';
                        button.style.marginTop = '10px';
                        button.addEventListener('click', () => {
                            if (!input.value) {
                                this.showNotification('Proszƒô wybraƒá datƒô', 'error');
                                return;
                            }

                            // Validate date is not in the past
                            const selectedDate = new Date(input.value);
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            
                            if (selectedDate < today) {
                                this.showNotification('Data nie mo≈ºe byƒá w przesz≈Ço≈õci', 'error');
                                return;
                            }

                            // Validate date is not too far in future (max 3 months)
                            const maxDate = new Date();
                            maxDate.setMonth(maxDate.getMonth() + 3);
                            
                            if (selectedDate > maxDate) {
                                this.showNotification('Prosimy wybraƒá datƒô w ciƒÖgu najbli≈ºszych 3 miesiƒôcy', 'warning');
                                return;
                            }

                            this.handleDateSelection(input.value, response, index);
                        });

                        dateGroup.appendChild(label);
                        dateGroup.appendChild(input);
                        dateGroup.appendChild(button);
                        this.responseButtons.appendChild(dateGroup);
                    } else {
                        const button = document.createElement('button');
                        button.className = 'response-btn';
                        button.textContent = response.label;

                        if (response.label.includes('UM√ìWIONO') || response.label.toLowerCase().includes('um√≥wiono')) {
                            button.classList.add('success');
                        } else if (response.label.includes('NIE ZAINTERESOWANY') || response.label.includes('Z≈ÅY NUMER')) {
                            button.classList.add('danger');
                        } else if (response.label.includes('ODDZWONIƒÜ') || response.label.toLowerCase().includes('p√≥≈∫niej')) {
                            button.classList.add('warning');
                        }

                        button.addEventListener('click', () => this.handleResponse(index));
                        this.responseButtons.appendChild(button);
                    }
                });

                this.backBtn.style.display = this.engine.history.length > 0 ? 'block' : 'none';
                this.updateHistory();
            }

            handleDateSelection(dateValue, response, index) {
                const selectedDate = new Date(dateValue);
                const dateStr = selectedDate.toLocaleDateString('pl-PL', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const currentStep = this.engine.getCurrentStep();
                this.engine.history.push({
                    step: this.engine.currentStep,
                    stepName: currentStep.name || this.engine.currentStep,
                    said: currentStep.say,
                    response: `${response.label} - ${dateStr}`,
                    selectedDate: dateValue
                });

                if (response.next === null) {
                    this.showEndScreen(response.label);
                } else {
                    this.engine.currentStep = response.next;
                    this.render();
                }
            }

            handleResponse(index) {
                const result = this.engine.selectResponse(index);

                if (result.end) {
                    this.showEndScreen(result.outcome);
                } else {
                    this.render();
                }
            }

            handleBack() {
                const success = this.engine.goBack();
                if (success) {
                    this.render();
                }
            }

            handleClose() {
                t.closeModal();
            }

            updateHistory() {
                const history = this.engine.getHistory();

                if (history.length === 0) {
                    this.historyPanel.style.display = 'none';
                    return;
                }

                this.historyPanel.style.display = 'block';
                this.historyList.innerHTML = '';

                history.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.textContent = `${index + 1}. ${item.stepName || 'Krok'} -> ${item.response}`;
                    this.historyList.appendChild(historyItem);
                });
            }

            async showEndScreen(outcome) {
                // Sprawd≈∫ czy outcome wymaga dodatkowych danych
                const needsDetails = this.outcomeNeedsDetails(outcome);
                
                if (needsDetails) {
                    this.showDetailsForm(outcome);
                } else {
                    // Bezpo≈õrednio zapisz bez formularza
                    await this.saveAndFinish(outcome, {});
                }
            }

            outcomeNeedsDetails(outcome) {
                // Sprawd≈∫ czy outcome wymaga dodatkowych danych (data, adres, etc.)
                const patterns = {
                    'UMOWIONO': /um[o√≥]wiono/i,
                    'CALLBACK': /oddzwoni[cƒá]/i,
                };
                
                for (const pattern of Object.values(patterns)) {
                    if (pattern.test(outcome)) {
                        return true;
                    }
                }
                
                return false;
            }

            showDetailsForm(outcome) {
                const container = document.getElementById('script-content');
                const isUmowiono = /um[o√≥]wiono/i.test(outcome);
                
                // Generuj opcje godzin
                const hours = [];
                for (let h = 9; h <= 20; h++) {
                    hours.push(`<option value="${h}:00">${h}:00</option>`);
                }
                
                container.innerHTML = `
                    <div class="details-form">
                        <h3>${isUmowiono ? '‚úÖ UM√ìWIONO' : '‚è∞ ODDZWONIƒÜ'}</h3>
                        <p style="margin-bottom: 20px;">Uzupe≈Çnij szczeg√≥≈Çy przed zapisaniem:</p>
                        
                        <div class="form-group">
                            <label class="form-label">üìÖ Data ${isUmowiono ? 'spotkania' : 'callback'}:</label>
                            <input type="date" id="details-date" class="form-input" 
                                   min="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">üïê Godzina:</label>
                            <select id="details-time" class="form-input" required>
                                <option value="">-- wybierz --</option>
                                ${hours.join('')}
                            </select>
                        </div>
                        
                        ${isUmowiono ? `
                        <div class="form-group">
                            <label class="form-label">üìç Adres spotkania:</label>
                            <textarea id="details-address" class="form-textarea" 
                                      placeholder="ul. Przyk≈Çadowa 123&#10;00-000 Warszawa" 
                                      rows="3"></textarea>
                        </div>
                        ` : ''}
                        
                        <div class="form-group">
                            <label class="form-label">üè∑Ô∏è Etykiety:</label>
                            <div class="checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" value="6388eba8dc90ef0163c62a73" 
                                           ${isUmowiono ? 'checked' : ''}>
                                    <span class="label-badge label-green">‚úÖ Um√≥wione</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="63b6d963b75c760443ab712f"
                                           ${!isUmowiono ? 'checked' : ''}>
                                    <span class="label-badge label-orange">‚è∞ W p√≥≈∫niejszym terminie</span>
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" value="68889670d8479029195b3fd2">
                                    <span class="label-badge label-red">üìû Nie odbiera</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button id="save-details-btn" class="response-btn success">
                                üíæ Zapisz i zako≈Ñcz rozmowƒô
                            </button>
                        </div>
                    </div>
                `;
                
                // Attach event listener
                document.getElementById('save-details-btn').addEventListener('click', () => {
                    this.handleDetailsSave(outcome);
                });
            }

            async handleDetailsSave(outcome) {
                const date = document.getElementById('details-date').value;
                const time = document.getElementById('details-time').value;
                const address = document.getElementById('details-address')?.value || '';
                
                // Walidacja
                if (!date) {
                    this.showNotification('Proszƒô wybraƒá datƒô', 'error');
                    return;
                }
                
                if (!time) {
                    this.showNotification('Proszƒô wybraƒá godzinƒô', 'error');
                    return;
                }
                
                // Pobierz zaznaczone etykiety
                const selectedLabels = Array.from(document.querySelectorAll('.checkbox-group input:checked'))
                    .map(cb => cb.value);
                
                const details = {
                    date: date,
                    time: time,
                    address: address,
                    labels: selectedLabels
                };
                
                await this.saveAndFinish(outcome, details);
            }

            async saveAndFinish(outcome, details) {
                // Poka≈º loading state
                const container = document.getElementById('script-content');
                container.innerHTML = `
                    <div class="end-screen">
                        <h3>‚è≥ Zapisywanie...</h3>
                        <p>Aktualizacja karty w Trello...</p>
                    </div>
                `;

                // Wykonaj automatyczne akcje w Trello
                const automationResults = await this.executeAutomation(outcome, details);

                // Poka≈º rezultat
                if (automationResults.success) {
                    const actionsHtml = this.formatActionsResult(automationResults.actions);
                    container.innerHTML = `
                        <div class="end-screen">
                            <h3>‚úÖ Rozmowa zako≈Ñczona</h3>
                            <p><strong>Wynik:</strong> ${outcome}</p>
                            ${actionsHtml}
                            <p style="margin-top: 20px;">Mo≈ºesz teraz zamknƒÖƒá to okno.</p>
                        </div>
                    `;
                } else {
                    // Show conversation history if save failed
                    const history = this.engine.getHistory();
                    let historyText = history.map((item, idx) => 
                        `${idx + 1}. ${item.stepName}: ${item.response}`
                    ).join('\n');
                    
                    container.innerHTML = `
                        <div class="end-screen">
                            <h3>‚ö†Ô∏è Rozmowa zako≈Ñczona</h3>
                            <p><strong>Wynik:</strong> ${outcome}</p>
                            <p class="warning">Nie uda≈Ço siƒô zapisaƒá komentarza w Trello.</p>
                            <p>Proszƒô skopiowaƒá poni≈ºszy przebieg rozmowy rƒôcznie:</p>
                            <textarea style="width:100%; height:200px; margin:10px 0; padding:10px; font-family:monospace; font-size:12px;" readonly>${historyText}</textarea>
                            <button onclick="this.previousElementSibling.select();document.execCommand('copy');alert('Skopiowano!');" class="response-btn">üìã Skopiuj</button>
                        </div>
                    `;
                }

                this.closeBtn.textContent = '‚úì Zamknij i wr√≥ƒá do Trello';
                this.backBtn.style.display = 'none';
            }

            async executeAutomation(outcome, details = {}) {
                try {
                    const history = this.engine.getHistory();
                    
                    const conversationData = {
                        history: history,
                        selectedDate: details.date || null,
                        selectedTime: details.time || null,
                        address: details.address || '',
                        labels: details.labels || []
                    };

                    // Utw√≥rz instancjƒô automation engine
                    const automation = new TrelloAutomation(t, TRELLO_ACTIONS_CONFIG, APP_KEY);
                    
                    // Wykonaj akcje
                    const results = await automation.executeOutcomeActions(outcome, conversationData);
                    
                    if (results.success) {
                        this.showNotification('‚úì Akcje w Trello wykonane', 'success');
                    } else {
                        this.showNotification('‚ö†Ô∏è Niekt√≥re akcje nie powiod≈Çy siƒô', 'warning');
                    }

                    return results;

                } catch (error) {
                    console.error('B≈ÇƒÖd automatyzacji:', error);
                    this.showNotification('B≈ÇƒÖd po≈ÇƒÖczenia z Trello', 'error');
                    
                    return {
                        success: false,
                        error: error.message,
                        actions: {},
                        errors: [{ action: 'general', error: error.message }]
                    };
                }
            }

            formatActionsResult(actions) {
                let html = '<div style="margin-top: 15px; text-align: left;">';
                html += '<p><strong>Wykonane akcje:</strong></p>';
                html += '<ul style="text-align: left; margin-left: 20px;">';
                
                if (actions.label) html += '<li>‚úì Dodano etykietƒô</li>';
                if (actions.dueDate) html += '<li>‚úì Ustawiono datƒô (due date)</li>';
                if (actions.comment) html += '<li>‚úì Dodano komentarz z historiƒÖ rozmowy</li>';
                if (actions.move) html += '<li>‚úì Przeniesiono kartƒô na odpowiedniƒÖ listƒô</li>';
                
                if (Object.keys(actions).length === 0) {
                    html += '<li>‚ÑπÔ∏è Brak automatycznych akcji dla tego typu zako≈Ñczenia</li>';
                }
                
                html += '</ul>';
                html += '</div>';
                
                return html;
            }

            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification notification-${type}`;
                notification.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            }

            showError(message) {
                const container = document.getElementById('script-content');
                container.innerHTML = `
                    <div class="end-screen">
                        <h3>B≈ÇƒÖd</h3>
                        <p>${message}</p>
                    </div>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const scriptEngine = new ScriptEngine(SCRIPT_DATA);
            const scriptUI = new ScriptUI(scriptEngine);
        });
    </script>
</body>
</html>
